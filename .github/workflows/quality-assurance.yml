name: Quality Assurance

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'

jobs:
  comprehensive-quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.2
      
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run strict deployment quality checks
        run: pnpm run deploy:check:strict
      
      - name: Check for missing alt tags
        run: |
          echo "Checking for images without alt tags..."
          ! grep -r "img src" src/ --include="*.tsx" --include="*.jsx" | grep -v "alt="
          ! grep -r "<Image" src/ --include="*.tsx" --include="*.jsx" | grep -v "alt="
        continue-on-error: true
      
      - name: Check for TODO and FIXME comments
        run: |
          echo "Checking for unresolved TODOs and FIXMEs..."
          grep -rn "TODO\|FIXME" src/ --include="*.ts" --include="*.tsx" || echo "No TODOs or FIXMEs found"
        continue-on-error: true
      
      - name: Check for console.log statements
        run: |
          echo "Checking for console.log statements in production code..."
          ! grep -rn "console\.log" src/ --include="*.ts" --include="*.tsx" | grep -v "// " | grep -v "//"
        continue-on-error: true
      
      - name: Verify SEO metadata structure
        run: |
          echo "Checking for metadata exports in page files..."
          find src/app -name "page.tsx" -type f -exec sh -c 'grep -q "export const metadata" {} || echo "Missing metadata in: {}"' \;
        continue-on-error: true
      
      - name: Check accessibility patterns
        run: |
          echo "Checking for common accessibility issues..."
          ! grep -r "onClick=" src/ --include="*.tsx" | grep -v "onKeyDown\|onKeyPress\|onKeyUp\|role="
        continue-on-error: true
      
      - name: Verify image optimization
        run: |
          echo "Checking for unoptimized image usage..."
          ! grep -r "<img" src/ --include="*.tsx" --include="*.jsx" | grep -v "next/image"
        continue-on-error: true
      
      - name: Check for hardcoded URLs
        run: |
          echo "Checking for hardcoded URLs that should use environment variables..."
          ! grep -rn "http://localhost\|https://bespokeethos.com" src/ --include="*.ts" --include="*.tsx" | grep -v "NEXT_PUBLIC_SITE_URL\|process.env"
        continue-on-error: true
      
      - name: Build and analyze bundle
        run: |
          pnpm build
          echo "Analyzing bundle size..."
          if [ -d ".next" ]; then
            echo "=== Build Output Size ==="
            du -sh .next
            echo "=== Static Assets Size ==="
            du -sh .next/static
            echo "=== Server Size ==="
            du -sh .next/server 2>/dev/null || echo "Server directory not found"
            echo "=== Largest files in build ==="
            find .next -type f -exec du -h {} + | sort -rh | head -20
          fi
      
      - name: Check for TypeScript strict mode
        run: |
          echo "Verifying TypeScript strict mode is enabled..."
          grep -q '"strict": true' tsconfig.json && echo "✓ Strict mode enabled" || echo "✗ Strict mode not enabled"
      
      - name: Dependency vulnerability check
        run: |
          echo "Running security audit..."
          pnpm audit --json > audit-results.json || true
          if [ -f audit-results.json ]; then
            cat audit-results.json
          fi
        continue-on-error: true
      
      - name: Check for duplicate dependencies
        run: |
          echo "Checking for duplicate dependencies..."
          pnpm list --depth=0 > deps.txt
          sort deps.txt | uniq -d || echo "No duplicate dependencies found"
        continue-on-error: true

  lighthouse-audit:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.2
      
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build application
        run: pnpm build
      
      - name: Start server
        run: |
          pnpm start &
          sleep 10
        continue-on-error: true
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
