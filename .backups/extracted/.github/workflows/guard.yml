name: Guardrails

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch: {}

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Enable Corepack
        run: corepack enable
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Run checks
        env:
          REQUIRED_VERCEL_PROJECT_ID: prj_444RgNkeGtkyGFSdm59T1hSwjz0F
          NEXT_PUBLIC_SITE_URL: https://www.bespokeethos.com
          # BASEHUB_TOKEN intentionally omitted in CI; guard will remind for real deploys
        run: |
          node scripts/predeploy-guard.mjs || true
          pnpm run check
      - name: Block non-main deploys
        if: github.ref != 'refs/heads/main'
        run: echo "Non-main branch: deployments are blocked by guardrails." && exit 0
